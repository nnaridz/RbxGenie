// Bundles all plugin Lua modules into a single self-contained plugin file.
// Output: dist/RbxGenie.plugin.lua
// Usage: node scripts/bundle.js

const fs = require("fs");
const path = require("path");

const PLUGIN_DIR = path.join(__dirname, "..", "plugin");
const OUT_DIR = path.join(__dirname, "..", "dist");
const OUT_FILE = path.join(OUT_DIR, "RbxGenie.plugin.lua");

// Dependency-ordered modules. Each entry: { name, file }
// 'name' is the key used in _M[]. 'file' is relative to plugin/.
const MODULES = [
    { name: "PathResolver", file: "PathResolver.lua" },
    { name: "ValueSerializer", file: "ValueSerializer.lua" },
    { name: "tools.AttributeTools", file: "tools/AttributeTools.lua" },
    { name: "tools.TagTools", file: "tools/TagTools.lua" },
    { name: "tools.SelectionTools", file: "tools/SelectionTools.lua" },
    { name: "tools.ExecuteTools", file: "tools/ExecuteTools.lua" },
    { name: "tools.PlaytestTools", file: "tools/PlaytestTools.lua" },
    { name: "tools.InsertModelTools", file: "tools/InsertModelTools.lua" },
    { name: "tools.ScriptTools", file: "tools/ScriptTools.lua" },
    { name: "tools.PropertyTools", file: "tools/PropertyTools.lua" },
    { name: "tools.ObjectTools", file: "tools/ObjectTools.lua" },
    { name: "tools.InstanceTools", file: "tools/InstanceTools.lua" },
    { name: "Executor", file: "Executor.lua" },
    { name: "UI", file: "UI.lua" },
    { name: "Bridge", file: "Bridge.lua" },
];

// Map from require(script.X.Y) patterns → _M["key"] lookups.
// Order matters: longer/more specific patterns first.
const REQUIRE_REPLACEMENTS = [
    // From tools — two levels up for shared modules
    [/require\(script\.Parent\.Parent\.PathResolver\)/g, '_M["PathResolver"]'],
    [/require\(script\.Parent\.Parent\.ValueSerializer\)/g, '_M["ValueSerializer"]'],

    // From Executor — one level up + tools subfolder
    [/require\(script\.Parent\.tools\.InstanceTools\)/g, '_M["tools.InstanceTools"]'],
    [/require\(script\.Parent\.tools\.PropertyTools\)/g, '_M["tools.PropertyTools"]'],
    [/require\(script\.Parent\.tools\.ObjectTools\)/g, '_M["tools.ObjectTools"]'],
    [/require\(script\.Parent\.tools\.ScriptTools\)/g, '_M["tools.ScriptTools"]'],
    [/require\(script\.Parent\.tools\.AttributeTools\)/g, '_M["tools.AttributeTools"]'],
    [/require\(script\.Parent\.tools\.TagTools\)/g, '_M["tools.TagTools"]'],
    [/require\(script\.Parent\.tools\.SelectionTools\)/g, '_M["tools.SelectionTools"]'],
    [/require\(script\.Parent\.tools\.ExecuteTools\)/g, '_M["tools.ExecuteTools"]'],
    [/require\(script\.Parent\.tools\.PlaytestTools\)/g, '_M["tools.PlaytestTools"]'],
    [/require\(script\.Parent\.tools\.InsertModelTools\)/g, '_M["tools.InsertModelTools"]'],

    // From Bridge — sibling modules
    [/require\(script\.Parent\.Executor\)/g, '_M["Executor"]'],
    [/require\(script\.Parent\.UI\)/g, '_M["UI"]'],
    [/require\(script\.Parent\.Bridge\)/g, '_M["Bridge"]'],

    // From init.server — children of main Script (filesystem layout)
    [/require\(script\.Bridge\)/g, '_M["Bridge"]'],
    [/require\(script\.UI\)/g, '_M["UI"]'],
    [/require\(script\.Executor\)/g, '_M["Executor"]'],
    [/require\(script\.PathResolver\)/g, '_M["PathResolver"]'],
    [/require\(script\.ValueSerializer\)/g, '_M["ValueSerializer"]'],
];

function applyReplacements(src) {
    for (const [pattern, replacement] of REQUIRE_REPLACEMENTS) {
        src = src.replace(pattern, replacement);
    }
    return src;
}

function stripStrict(src) {
    return src.replace(/^--!strict\s*\n?/m, "");
}

function readModule(file) {
    const fullPath = path.join(PLUGIN_DIR, file);
    if (!fs.existsSync(fullPath)) {
        console.warn(`  WARN: missing ${file}`);
        return "";
    }
    return fs.readFileSync(fullPath, "utf8");
}

function wrapModule(name, src) {
    src = stripStrict(src);
    src = applyReplacements(src);
    // Indent module body
    const indented = src
        .split("\n")
        .map((l) => "  " + l)
        .join("\n");
    return `_M["${name}"] = (function()\n${indented}\nend)()\n`;
}

function buildMain(src) {
    src = stripStrict(src);
    src = applyReplacements(src);
    return src;
}

// ── Build ─────────────────────────────────────────────────────────────────────

if (!fs.existsSync(OUT_DIR)) fs.mkdirSync(OUT_DIR, { recursive: true });

const header = `--!nonstrict
-- RbxGenie Plugin (bundled single-file build)
-- Generated by scripts/bundle.js — do not edit manually.
-- Place this file in: %LOCALAPPDATA%\\Roblox\\Plugins\\RbxGenie.lua

local _M = {}

`;

let output = header;

for (const mod of MODULES) {
    console.log(`  Bundling: ${mod.name} (${mod.file})`);
    const src = readModule(mod.file);
    output += `-- ── Module: ${mod.name} ${"─".repeat(Math.max(0, 55 - mod.name.length))}\n`;
    output += wrapModule(mod.name, src);
    output += "\n";
}

// Main init code
console.log("  Bundling: init.server (main)");
const initSrc = readModule("init.server.lua");
output += `-- ── Main Plugin Script ${"─".repeat(36)}\n`;
output += buildMain(initSrc);

fs.writeFileSync(OUT_FILE, output, "utf8");

const kb = (fs.statSync(OUT_FILE).size / 1024).toFixed(1);
console.log(`\n✓ Bundled → dist/RbxGenie.plugin.lua (${kb} KB)`);
console.log(`\nInstall:\n  copy "${OUT_FILE}" "%LOCALAPPDATA%\\Roblox\\Plugins\\RbxGenie.lua"`);
